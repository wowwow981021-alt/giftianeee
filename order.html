<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì£¼ë¬¸ì„œ ì‘ì„± | IAN SHOP</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // í…”ë ˆê·¸ë¨ WebApp ê°•ì œ í™•ì¥ (ëª¨ë°”ì¼ ìµœì í™”)
    (function() {
      function forceExpand() {
        if (window.Telegram && window.Telegram.WebApp) {
          try {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            if (window.Telegram.WebApp.viewportHeight) {
              window.Telegram.WebApp.expand();
            }
          } catch (e) {
            console.error('í…”ë ˆê·¸ë¨ WebApp í™•ì¥ ì˜¤ë¥˜:', e);
          }
        }
      }
      forceExpand();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceExpand);
      }
      setTimeout(forceExpand, 100);
      setTimeout(forceExpand, 500);
      window.addEventListener('load', forceExpand);
    })();
  </script>
</head>
<body>

<h1>ì£¼ë¬¸ì„œ ì‘ì„±</h1>

<div class="page-nav">
  <a href="index.html"><button>ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button></a>
  <a href="index.html"><button>â¬… ì´ì „ í™”ë©´</button></a>
  <a href="support.html"><button class="support-btn">ğŸ’¬ ê³ ê° ìƒë‹´</button></a>
</div>

<hr>

<h3>ì£¼ë¬¸ ìƒí’ˆ</h3>
<div id="orderItems"></div>
<p id="orderTotal"></p>

<hr>

<h3>ì£¼ë¬¸ì ì •ë³´</h3>
<p style="font-size: 0.85em; color: #666; margin-top: -10px; margin-bottom: 15px;">(ì¥ë°”êµ¬ë‹ˆ ë§ìœ¼ë©´ ì…ë ¥ ì§€ì—° ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.)</p>
<form onsubmit="submitOrder(event)">
  <label>ì´ë¦„<br><input type="text" id="name" required autocomplete="name" style="pointer-events: auto !important; user-select: text !important;"></label><br><br>
  <label>ì—°ë½ì²˜<br><input type="tel" id="phone" required placeholder="010-0000-0000" autocomplete="tel" style="pointer-events: auto !important; user-select: text !important;"></label><br><br>
  <label>ë°°ì†¡ ì£¼ì†Œ<br><input type="text" id="address" required autocomplete="street-address" style="pointer-events: auto !important; user-select: text !important;"></label><br><br>
  <label>ìš”ì²­ì‚¬í•­ (ì„ íƒ)<br><textarea id="memo" style="pointer-events: auto !important; user-select: text !important;"></textarea></label><br><br>
  <button type="submit">ê²°ì œ ì„ íƒìœ¼ë¡œ ì´ë™</button>
</form>

<hr>
<a href="index.html"><button>ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button></a>
<a href="index.html"><button>â¬… ì´ì „ í™”ë©´</button></a>

<script src="cart.js"></script>
<script>
// ì…ë ¥ í•„ë“œ í™œì„±í™” í•¨ìˆ˜ (ìµœìš°ì„  ì²˜ë¦¬)
function enableInputFields() {
  const inputs = document.querySelectorAll('input[type="text"], input[type="tel"], textarea');
  inputs.forEach(input => {
    // ëª¨ë“  ì°¨ë‹¨ ì†ì„± ì œê±°
    input.removeAttribute('readonly');
    input.removeAttribute('disabled');
    input.removeAttribute('tabindex');
    
    // ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
    input.style.pointerEvents = 'auto';
    input.style.userSelect = 'text';
    input.style.webkitUserSelect = 'text';
    input.style.mozUserSelect = 'text';
    input.style.msUserSelect = 'text';
    input.style.cursor = 'text';
    input.style.opacity = '1';
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¡œ í¬ì»¤ìŠ¤ ë³´ì¥
    input.addEventListener('click', function(e) {
      e.stopPropagation();
      this.focus();
    }, { passive: true });
    
    input.addEventListener('touchstart', function(e) {
      e.stopPropagation();
    }, { passive: true });
  });
}

// ì¦‰ì‹œ ì…ë ¥ í•„ë“œ í™œì„±í™” (ìµœìš°ì„ )
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', enableInputFields);
} else {
  enableInputFields();
}

// ì¦‰ì‹œ ì‹¤í–‰
enableInputFields();
setTimeout(enableInputFields, 0);

// ìƒí’ˆ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ë¹„ë™ê¸° ì²˜ë¦¬, ë°°ì¹˜ ë Œë”ë§)
function renderOrderItems() {
  const cart = getCart();
  const itemsDiv = document.getElementById("orderItems");
  const totalDiv = document.getElementById("orderTotal");

  if (!itemsDiv || !totalDiv) return;

  // í• ì¸ ì •ë³´ í¬í•¨ ì´ì•¡ ê³„ì‚°
  const totals = calculateTotal();

  // ì´ì•¡ ë¨¼ì € ë Œë”ë§ (ì¤‘ìš”í•œ ì •ë³´)
  let totalHtml = `<div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
      <span>ìƒí’ˆ ê¸ˆì•¡:</span>
      <span>â‚©${totals.subtotal.toLocaleString()}</span>
    </div>`;

  if(totals.discount > 0) {
    totalHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #4CAF50;">
      <span>í• ì¸ (${totals.discountText}):</span>
      <span>-â‚©${totals.discount.toLocaleString()}</span>
    </div>`;
  }

  totalHtml += `<div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid #333; font-size: 1.2em; font-weight: bold;">
      <span>ì´ ê²°ì œ ê¸ˆì•¡:</span>
      <span>â‚©${totals.total.toLocaleString()}</span>
    </div>
  </div>`;

  totalDiv.innerHTML = totalHtml;

  // ìƒí’ˆ ëª©ë¡ì€ ë°°ì¹˜ë¡œ ë‚˜ëˆ„ì–´ ë Œë”ë§ (ë§ì€ í•­ëª©ì¼ ë•Œ UI ë¸”ë¡œí‚¹ ë°©ì§€)
  if (cart.length > 10) {
    // ë§ì€ í•­ëª©ì¼ ë•Œ ë°°ì¹˜ ë Œë”ë§
    itemsDiv.innerHTML = '<div style="padding: 8px 0;">ë¡œë”© ì¤‘...</div>';
    
    let index = 0;
    const batchSize = 10;
    
    function renderBatch() {
      const fragment = document.createDocumentFragment();
      const end = Math.min(index + batchSize, cart.length);
      
      for (let i = index; i < end; i++) {
        const item = cart[i];
        const itemDiv = document.createElement('div');
        itemDiv.style.padding = '8px 0';
        itemDiv.style.borderBottom = '1px solid #eee';
        itemDiv.textContent = `${item.name} Ã— ${item.qty} (â‚©${(item.price*item.qty).toLocaleString()})`;
        fragment.appendChild(itemDiv);
      }
      
      if (index === 0) {
        itemsDiv.innerHTML = '';
      }
      itemsDiv.appendChild(fragment);
      
      index = end;
      
      if (index < cart.length) {
        // ë‹¤ìŒ ë°°ì¹˜ë¥¼ ë¹„ë™ê¸°ë¡œ ë Œë”ë§
        setTimeout(renderBatch, 0);
      }
    }
    
    renderBatch();
  } else {
    // ì ì€ í•­ëª©ì¼ ë•ŒëŠ” í•œ ë²ˆì— ë Œë”ë§
    const fragment = document.createDocumentFragment();
    cart.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.style.padding = '8px 0';
      itemDiv.style.borderBottom = '1px solid #eee';
      itemDiv.textContent = `${item.name} Ã— ${item.qty} (â‚©${(item.price*item.qty).toLocaleString()})`;
      fragment.appendChild(itemDiv);
    });
    itemsDiv.innerHTML = '';
    itemsDiv.appendChild(fragment);
  }
}

// DOM ë¡œë“œ í›„ ì‹¤í–‰ - ì…ë ¥ í•„ë“œ ë¨¼ì € í™œì„±í™”, ìƒí’ˆ ëª©ë¡ì€ ë‚˜ì¤‘ì— ë Œë”ë§
document.addEventListener('DOMContentLoaded', function() {
  // ì…ë ¥ í•„ë“œ ì¦‰ì‹œ í™œì„±í™” (ìµœìš°ì„ )
  enableInputFields();
  
  // ìƒí’ˆ ëª©ë¡ì€ ë¹„ë™ê¸°ë¡œ ë‚˜ì¤‘ì— ë Œë”ë§ (UI ë¸”ë¡œí‚¹ ë°©ì§€)
  setTimeout(function() {
    renderOrderItems();
  }, 0);
  
  // ì¶”ê°€ ë³´ì¥
  requestAnimationFrame(function() {
    enableInputFields();
    setTimeout(enableInputFields, 0);
  });
});

// submitOrder í•¨ìˆ˜ëŠ” ì „ì—­ìœ¼ë¡œ ìœ ì§€
function submitOrder(e){
  e.preventDefault();
  const cart = getCart();
  const totals = calculateTotal();
  
  const orderInfo = {
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    memo: document.getElementById("memo").value,
    cart,
    total: totals.total,
    subtotal: totals.subtotal,
    discount: totals.discount,
    discountText: totals.discountText,
    coupon: totals.coupon
  };
  localStorage.setItem("order", JSON.stringify(orderInfo));
  window.location.href = "secure-pay-v2.html";
}
</script>

</body>
</html>
