<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ê²°ì œ ì„ íƒ | IAN SHOP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=" id="styleSheet" />
  <script src="https://telegram.org/js/telegram-web-app.js?v=" id="telegramScript"></script>
  <script>
    // ìºì‹œ ë°©ì§€: CSSì™€ JS ê²½ë¡œì— íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    const cacheBuster = Date.now();
    document.getElementById('styleSheet').href = `style.css?v=${cacheBuster}`;
    document.getElementById('telegramScript').src = `https://telegram.org/js/telegram-web-app.js?v=${cacheBuster}`;
    
    // í…”ë ˆê·¸ë¨ WebApp ê°•ì œ í™•ì¥ (ëª¨ë°”ì¼ ìµœì í™”)
    (function() {
      function forceExpand() {
        if (window.Telegram && window.Telegram.WebApp) {
          try {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            if (window.Telegram.WebApp.viewportHeight) {
              window.Telegram.WebApp.expand();
            }
          } catch (e) {
            console.error('í…”ë ˆê·¸ë¨ WebApp í™•ì¥ ì˜¤ë¥˜:', e);
          }
        }
      }
      forceExpand();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceExpand);
      }
      setTimeout(forceExpand, 100);
      setTimeout(forceExpand, 500);
      window.addEventListener('load', forceExpand);
    })();
  </script>
</head>
<body>
<h2 style="color:red; background:yellow; text-align:center; padding:15px; margin:0; font-size:1.5em;">V2 - ì—…ë°ì´íŠ¸ ì™„ë£Œ</h2>

<h1>ê²°ì œ ì„ íƒ</h1>

<div class="page-nav">
  <a href="index.html"><button>ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button></a>
  <a href="order.html"><button>â¬… ì£¼ë¬¸ ì •ë³´ë¡œ ëŒì•„ê°€ê¸°</button></a>
  <a href="support.html"><button class="support-btn">ğŸ’¬ ê³ ê° ìƒë‹´</button></a>
</div>

<hr>

<div id="orderSummary"></div>

<h3>ê²°ì œ ë°©ë²• ì„ íƒ</h3>
<div class="payment-methods">
  <button type="button" id="btn-kakao-new" class="payment-method kakao-pay">ğŸ’³ ì¹´ì¹´ì˜¤í˜ì´</button>
  <button type="button" id="btn-card-new" class="payment-method card-pay">ğŸ’³ ì¹´ë“œê²°ì œ</button>
  <button type="button" id="btn-btc-new" class="payment-method bitcoin-pay">â‚¿ ë¹„íŠ¸ì½”ì¸</button>
</div>

<hr>
<div class="page-nav">
  <a href="index.html"><button>ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button></a>
  <a href="order.html"><button>â¬… ì£¼ë¬¸ ì •ë³´ë¡œ ëŒì•„ê°€ê¸°</button></a>
</div>

<!-- ê³ ê¸‰ ê²°ì œ ëª¨ë‹¬ -->
<div id="paymentModal" class="payment-modal-new" style="display: none;">
  <div class="payment-modal-content-new">
    <div class="payment-modal-header">
      <h2 id="paymentModalTitle">ê²°ì œ ì§„í–‰</h2>
    </div>
    <div class="payment-modal-body" id="paymentModalBody">
      <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ì‚½ì…ë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>

<style>
/* ê²°ì œ ëª¨ë‹¬ ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ */
.payment-modal-new {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.payment-modal-content-new {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.payment-modal-header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #f0f0f0;
}

.payment-modal-header h2 {
  margin: 0;
  color: #2c3e50;
  font-size: 1.8em;
  font-weight: 700;
}

.payment-modal-body {
  text-align: center;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ - ì¹´ì¹´ì˜¤í˜ì´ (ë…¸ë€ìƒ‰ ë°”) */
.loading-kakao {
  width: 100%;
  height: 60px;
  background: #f0f0f0;
  border-radius: 30px;
  overflow: hidden;
  position: relative;
  margin: 30px 0;
}

.loading-kakao::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, #FEE500 0%, #FFD400 100%);
  animation: kakaoLoading 1.5s ease-in-out infinite;
}

@keyframes kakaoLoading {
  0% {
    left: -100%;
  }
  100% {
    left: 100%;
  }
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ - ì¹´ë“œê²°ì œ (ì‹ ìš©ì¹´ë“œ ì•„ì´ì½˜ íšŒì „) */
.loading-card {
  width: 80px;
  height: 80px;
  margin: 30px auto;
  position: relative;
}

.loading-card::before {
  content: 'ğŸ’³';
  position: absolute;
  font-size: 60px;
  animation: cardSpin 1s linear infinite;
}

@keyframes cardSpin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ - ë¹„íŠ¸ì½”ì¸ (ì½”ì¸ íšŒì „) */
.loading-bitcoin {
  width: 80px;
  height: 80px;
  margin: 30px auto;
  position: relative;
}

.loading-bitcoin::before {
  content: 'â‚¿';
  position: absolute;
  font-size: 60px;
  color: #F7931A;
  animation: bitcoinSpin 1s ease-in-out infinite;
}

@keyframes bitcoinSpin {
  0%, 100% {
    transform: rotateY(0deg) scale(1);
  }
  50% {
    transform: rotateY(180deg) scale(1.2);
  }
}

/* ìƒíƒœ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
.payment-status-message {
  font-size: 1.3em;
  font-weight: 600;
  color: #2c3e50;
  margin: 20px 0;
  min-height: 30px;
  animation: fadeInOut 0.5s ease-in-out;
}

@keyframes fadeInOut {
  0%, 100% {
    opacity: 0;
  }
  50% {
    opacity: 1;
  }
}

/* ë²„íŠ¼ ëˆŒë¦¼ íš¨ê³¼ */
.payment-method {
  transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
  transform-origin: center;
}

.payment-method:active {
  transform: scale(0.95);
}

.payment-method.processing {
  pointer-events: none;
  opacity: 0.6;
  cursor: not-allowed;
}

.payment-methods.processing {
  pointer-events: none;
}

/* ì„±ê³µ ì•„ì´ì½˜ */
.success-icon-large {
  font-size: 80px;
  color: #4CAF50;
  margin: 20px 0;
  animation: scaleIn 0.5s ease-out;
}

@keyframes scaleIn {
  0% {
    transform: scale(0);
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
  }
}
</style>

<script>
// ============================================
// ê³ ê¸‰ ê²°ì œ ì‹œìŠ¤í…œ - ì™„ì „íˆ ìƒˆë¡œìš´ êµ¬í˜„
// ============================================

let isProcessing = false;
let currentPaymentMethod = '';
let paymentSteps = [];
let orderData = {};

// ì£¼ë¬¸ ì •ë³´ í‘œì‹œ
function displayOrderSummary() {
  const order = JSON.parse(localStorage.getItem("order")) || {};
  orderData = order;
  
  const summaryDiv = document.getElementById("orderSummary");
  
  if (order.cart && order.cart.length > 0) {
    let html = `<div style="padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">`;
    
    html += `<h3 style="margin-top: 0; color: #2c3e50;">ì£¼ë¬¸ ë‚´ì—­</h3>`;
    
    order.cart.forEach(item => {
      html += `<div style="padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">`;
      html += `<span>${item.name} Ã— ${item.qty}</span>`;
      html += `<span style="font-weight: 600;">â‚©${(item.price * item.qty).toLocaleString()}</span>`;
      html += `</div>`;
    });
    
    html += `<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #2c3e50;">`;
    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;">`;
    html += `<span>ìƒí’ˆ ê¸ˆì•¡:</span>`;
    html += `<span>â‚©${(order.subtotal || order.total || 0).toLocaleString()}</span>`;
    html += `</div>`;
    
    if (order.discount && order.discount > 0) {
      html += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #4CAF50;">`;
      html += `<span>í• ì¸ (${order.discountText || 'í• ì¸'}):</span>`;
      html += `<span>-â‚©${order.discount.toLocaleString()}</span>`;
      html += `</div>`;
    }
    
    html += `<div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px solid #2c3e50; font-size: 1.3em; font-weight: bold; color: #2c3e50;">`;
    html += `<span>ì´ ê²°ì œ ê¸ˆì•¡:</span>`;
    html += `<span style="color: #e74c3c;">â‚©${(order.total || 0).toLocaleString()}</span>`;
    html += `</div>`;
    html += `</div></div>`;
    
    summaryDiv.innerHTML = html;
  }
}

// ê²°ì œ ì‹œì‘ í•¨ìˆ˜
function startAdvancedPayment(methodType) {
  if (isProcessing) {
    console.log('ê²°ì œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
    return;
  }
  
  isProcessing = true;
  currentPaymentMethod = methodType;
  
  // ë²„íŠ¼ ë¹„í™œì„±í™”
  const allButtons = document.querySelectorAll('.payment-method');
  const paymentMethods = document.querySelector('.payment-methods');
  
  allButtons.forEach(btn => btn.classList.add('processing'));
  if (paymentMethods) {
    paymentMethods.classList.add('processing');
  }
  
  // í…”ë ˆê·¸ë¨ í–…í‹± í”¼ë“œë°±
  if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
    try {
      window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    } catch (e) {
      console.log('í–…í‹± í”¼ë“œë°± ì‹¤íŒ¨:', e);
    }
  }
  
  // ëª¨ë‹¬ ì—´ê¸°
  openPaymentModal(methodType);
}

// ê²°ì œ ëª¨ë‹¬ ì—´ê¸°
function openPaymentModal(methodType) {
  const modal = document.getElementById('paymentModal');
  const modalTitle = document.getElementById('paymentModalTitle');
  const modalBody = document.getElementById('paymentModalBody');
  
  if (!modal || !modalTitle || !modalBody) {
    console.error('ê²°ì œ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    isProcessing = false;
    return;
  }
  
  // ê²°ì œ ë°©ë²•ë³„ ì„¤ì •
  const methodConfig = {
    'ì¹´ì¹´ì˜¤í˜ì´': {
      title: 'ğŸ’³ ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ',
      loadingClass: 'loading-kakao'
    },
    'ì¹´ë“œê²°ì œ': {
      title: 'ğŸ’³ ì¹´ë“œ ê²°ì œ',
      loadingClass: 'loading-card'
    },
    'ë¹„íŠ¸ì½”ì¸': {
      title: 'â‚¿ ë¹„íŠ¸ì½”ì¸ ê²°ì œ',
      loadingClass: 'loading-bitcoin'
    }
  };
  
  const config = methodConfig[methodType];
  if (!config) {
    console.error('ì•Œ ìˆ˜ ì—†ëŠ” ê²°ì œ ë°©ë²•:', methodType);
    isProcessing = false;
    return;
  }
  
  modalTitle.textContent = config.title;
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
  startPaymentProcess(methodType, config.loadingClass);
}

// ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
function startPaymentProcess(methodType, loadingClass) {
  const modalBody = document.getElementById('paymentModalBody');
  
  // ìƒíƒœ ë©”ì‹œì§€ ë°°ì—´
  const statusMessages = [
    'ê²°ì œ ì‹œë„ ì¤‘...',
    'ì¸ì¦ í™•ì¸ ì¤‘...',
    'ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ'
  ];
  
  let currentStep = 0;
  
  // ì²« ë²ˆì§¸ ìƒíƒœ í‘œì‹œ
  updatePaymentStatus(modalBody, methodType, loadingClass, statusMessages[currentStep]);
  
  // 1.2ì´ˆ ê°„ê²©ìœ¼ë¡œ ìƒíƒœ ë©”ì‹œì§€ ë³€ê²½
  const intervalId = setInterval(() => {
    currentStep++;
    
    if (currentStep < statusMessages.length) {
      updatePaymentStatus(modalBody, methodType, loadingClass, statusMessages[currentStep]);
    } else {
      clearInterval(intervalId);
      
      // ìµœì¢… ìŠ¹ì¸ í›„ ì™„ë£Œ í™”ë©´ í‘œì‹œ
      setTimeout(() => {
        showPaymentComplete(modalBody, methodType);
      }, 1200);
    }
  }, 1200);
}

// ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸
function updatePaymentStatus(modalBody, methodType, loadingClass, statusMessage) {
  modalBody.innerHTML = `
    <div class="${loadingClass}"></div>
    <div class="payment-status-message">${statusMessage}</div>
  `;
}

// ê²°ì œ ì™„ë£Œ í™”ë©´
function showPaymentComplete(modalBody, methodType) {
  // ì£¼ë¬¸ ë²ˆí˜¸ ìƒì„±
  const orderNumber = generateOrderNumber();
  
  // ì£¼ë¬¸ ì™„ë£Œ ë°ì´í„° ì €ì¥
  const orderComplete = {
    ...orderData,
    paymentMethod: methodType,
    orderNumber: orderNumber,
    orderDate: new Date().toISOString(),
    status: 'ê²°ì œì™„ë£Œ'
  };
  localStorage.setItem('orderComplete', JSON.stringify(orderComplete));
  
  // ì™„ë£Œ í™”ë©´ í‘œì‹œ
  modalBody.innerHTML = `
    <div class="success-icon-large">âœ“</div>
    <h3 style="color: #4CAF50; margin: 20px 0;">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
    <p style="font-size: 1.1em; color: #666; margin: 10px 0;">ì£¼ë¬¸ ë²ˆí˜¸: <strong style="color: #2c3e50;">${orderNumber}</strong></p>
    <p style="font-size: 1.1em; color: #666; margin: 10px 0;">ê²°ì œ ê¸ˆì•¡: <strong style="color: #e74c3c;">â‚©${(orderData.total || 0).toLocaleString()}</strong></p>
    <p style="color: #999; font-size: 0.9em; margin-top: 20px;">ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
  `;
  
  // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
  setTimeout(() => {
    window.location.href = 'order-complete.html';
  }, 2000);
}

// ì£¼ë¬¸ ë²ˆí˜¸ ìƒì„±
function generateOrderNumber() {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `ORD-${year}${month}${day}-${random}`;
}

// ì´ˆê¸°í™” í•¨ìˆ˜
function initializePaymentSystem() {
  // ì£¼ë¬¸ ì •ë³´ í‘œì‹œ
  displayOrderSummary();
  
  // ê²°ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (ì¸ë¼ì¸ ì´ë²¤íŠ¸ ê¸ˆì§€ - addEventListenerë§Œ ì‚¬ìš©)
  const kakaoBtn = document.getElementById('btn-kakao-new');
  const cardBtn = document.getElementById('btn-card-new');
  const btcBtn = document.getElementById('btn-btc-new');
  
  if (kakaoBtn) {
    kakaoBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      startAdvancedPayment('ì¹´ì¹´ì˜¤í˜ì´');
    }, { passive: false });
  }
  
  if (cardBtn) {
    cardBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      startAdvancedPayment('ì¹´ë“œê²°ì œ');
    }, { passive: false });
  }
  
  if (btcBtn) {
    btcBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      startAdvancedPayment('ë¹„íŠ¸ì½”ì¸');
    }, { passive: false });
  }
  
  console.log('ê³ ê¸‰ ê²°ì œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
}

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializePaymentSystem);
} else {
  // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
  initializePaymentSystem();
}
</script>

</body>
</html>
