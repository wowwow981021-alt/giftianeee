<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì‹ ì²­ ì™„ë£Œ | ì´ì•ˆí‹°ì¼“</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function() {
      function forceExpand() {
        if (window.Telegram && window.Telegram.WebApp) {
          try {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            if (window.Telegram.WebApp.viewportHeight) {
              window.Telegram.WebApp.expand();
            }
          } catch (e) {
            console.error('í…”ë ˆê·¸ë¨ WebApp í™•ì¥ ì˜¤ë¥˜:', e);
          }
        }
      }
      forceExpand();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceExpand);
      }
      setTimeout(forceExpand, 100);
      setTimeout(forceExpand, 500);
      window.addEventListener('load', forceExpand);
    })();
  </script>
</head>
<body>

<div class="order-complete-container">
  <div class="complete-icon">âœ“</div>
  <h1>ìƒí’ˆê¶Œ í˜„ê¸ˆêµí™˜ ì‹ ì²­ì´<br>ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h1>
  
  <div class="order-info-card">
    <h2>ì‹ ì²­ ì •ë³´</h2>
    <div id="orderCompleteInfo"></div>
  </div>
  
  <div class="notice-box" style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 12px; border-left: 4px solid #2196F3;">
    <h4 style="margin-top: 0; color: #1976d2;">ğŸ“‹ ì²˜ë¦¬ ì•ˆë‚´</h4>
    <ul style="margin: 10px 0; padding-left: 20px; color: #1565c0;">
      <li>ìƒí’ˆê¶Œ ê²€ì¦ì€ í‰ê·  1~2ì‹œê°„ ë‚´ ì™„ë£Œë©ë‹ˆë‹¤.</li>
      <li>ê²€ì¦ ì™„ë£Œ í›„ ì…ê¸ˆì€ 1~2ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.</li>
      <li>ì²˜ë¦¬ ìƒíƒœëŠ” 'ë‚´ ì£¼ë¬¸ì¡°íšŒ'ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ë¬¸ì˜ì‚¬í•­ì€ ê³ ê°ì„¼í„°ë¡œ ì—°ë½ì£¼ì„¸ìš”.</li>
    </ul>
  </div>
  
  <div class="order-actions">
    <a href="index.html"><button class="btn-primary">ë©”ì¸ìœ¼ë¡œ</button></a>
    <a href="order-inquiry.html"><button class="btn-secondary">ì£¼ë¬¸ ì¡°íšŒ</button></a>
  </div>
</div>

<script>
const lastOrderId = localStorage.getItem('lastOrderId');
const orders = JSON.parse(localStorage.getItem('giftCardOrders')) || [];
const order = orders.find(o => o.id === lastOrderId);

if (order) {
  // ==========================================
  // [í•µì‹¬] ê´€ë¦¬ì ë°±ì—”ë“œ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
  // ==========================================
  if (!order.isSentToServer) {
    fetch('http://127.0.0.1:5000/api/submit-exchange', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(order)
    })
    .then(response => response.json())
    .then(result => {
      if(result.success) {
        order.isSentToServer = true; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€
        localStorage.setItem('giftCardOrders', JSON.stringify(orders));
        console.log("ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì „ì†¡ ì„±ê³µ!");
      }
    })
    .catch(err => console.error("ì„œë²„ ì „ì†¡ ì—ëŸ¬:", err));
  }
  // ==========================================

  const infoDiv = document.getElementById('orderCompleteInfo');
  
  const date = new Date(order.createdAt);
  const dateStr = date.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  let html = `
    <div class="info-item">
      <span class="info-label">ì‹ ì²­ ë²ˆí˜¸</span>
      <span class="info-value">${order.id}</span>
    </div>
    <div class="info-item">
      <span class="info-label">ìƒí’ˆê¶Œ ì¢…ë¥˜</span>
      <span class="info-value">${order.cardName}</span>
    </div>
    <div class="info-item">
      <span class="info-label">ìƒí’ˆê¶Œ ê¸ˆì•¡</span>
      <span class="info-value">â‚©${order.amount.toLocaleString()}</span>
    </div>
    <div class="info-item">
      <span class="info-label">ë§¤ì… ì‹œì„¸</span>
      <span class="info-value">${order.rate}%</span>
    </div>
    <div class="info-item">
      <span class="info-label">ì˜ˆìƒ ì…ê¸ˆì•¡</span>
      <span class="info-value highlight">â‚©${order.expectedAmount.toLocaleString()}</span>
    </div>
    <div class="info-item">
      <span class="info-label">ì‹ ì²­ ì¼ì‹œ</span>
      <span class="info-value">${dateStr}</span>
    </div>
    <div class="info-item">
      <span class="info-label">ì²˜ë¦¬ ìƒíƒœ</span>
      <span class="info-value status-badge pending">ê²€ì¦ì¤‘</span>
    </div>
  `;
  
  if (order.accountHolder) {
    html += `
      <div class="delivery-info" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
        <h3>ì…ê¸ˆ ì •ë³´</h3>
        <p><strong>ì€í–‰:</strong> ${getBankName(order.bankName)}</p>
        <p><strong>ê³„ì¢Œë²ˆí˜¸:</strong> ${order.accountNumber}</p>
        <p><strong>ì˜ˆê¸ˆì£¼:</strong> ${order.accountHolder}</p>
      </div>
    `;
  }
  
  infoDiv.innerHTML = html;
} else {
  document.getElementById('orderCompleteInfo').innerHTML = 
    '<p>ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
}

function getBankName(code) {
  const banks = {
    'kb': 'KBêµ­ë¯¼ì€í–‰',
    'shinhan': 'ì‹ í•œì€í–‰',
    'woori': 'ìš°ë¦¬ì€í–‰',
    'hana': 'í•˜ë‚˜ì€í–‰',
    'nh': 'NHë†í˜‘ì€í–‰',
    'ibk': 'IBKê¸°ì—…ì€í–‰',
    'keb': 'KEBí•˜ë‚˜ì€í–‰',
    'kakao': 'ì¹´ì¹´ì˜¤ë±…í¬',
    'toss': 'í† ìŠ¤ë±…í¬'
  };
  return banks[code] || code;
}
</script>

<style>
.highlight {
  color: #667eea;
  font-size: 1.2em;
  font-weight: bold;
}

.status-badge {
  padding: 4px 12px;
  border-radius: 15px;
  font-size: 0.9em;
  font-weight: 600;
}

.status-badge.pending {
  background: #fff3e0;
  color: #e65100;
}
</style>

</body>
</html>
